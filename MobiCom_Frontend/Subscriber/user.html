<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script> <!-- Razorpay SDK -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --primary-teal: #008080;
            --primary-gradient: linear-gradient(135deg, #20b2aa 0%, #008080 100%);
            --secondary-gradient: linear-gradient(135deg, #00CED1 0%, #008B8B 100%);
            --background-color: #b3e1ff;
            --text-color: #334155;
            --card-bg: #FFFFFF;
            --border-radius: 12px;
        }

        .dashboard-card {
            height: 100%;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: none;
            background: white;
        }

        .dashboard-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }

        .icon-circle {
            background: var(--primary-gradient);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 15px;
        }

        .icon-circle i {
            color: white !important;
            font-size: 1rem;
        }

        .dashboard-card-title {
            color: var(--primary-teal);
            font-weight: bold;
            margin-bottom: 15px;
        }

        .dashboard-btn {
            background: var(--primary-gradient);
            color: white !important;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 10px 5px;
        }

        .dashboard-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .progress {
            height: 8px;
            border-radius: 3px;
            background: #e9ecef;
        }

        .progress-bar {
            background: var(--secondary-gradient) !important;
        }

        .validity-badge {
            background: var(--secondary-gradient);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .profile-image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }

        .profile-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-teal);
        }

        .profile-details {
            margin-top: 15px;
        }

        .profile-details p {
            margin-bottom: 10px;
            color: #555;
        }

        .card-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 90%;
            padding: 25px;
            text-align: center;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="user.html">Mobi.Comm</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard" onclick="showSection('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('plans')">Browse Plans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('support')">Support</a>
                    </li>
                </ul>
            </div>

            <div class="icon-container">
                <div class="dropdown">
                    <div class="avatar-icon" data-bs-toggle="dropdown" aria-expanded="false">
                        <img id="navbarAvatar" src="/assesst/Images/profile.jpeg" alt="Avatar" class="rounded-circle"
                            width="40" height="40" data-bs-toggle="tooltip" data-bs-title="Default Name">
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" onclick="showSection('profile')">Profile</a></li>
                        <li><a class="dropdown-item" onclick="showSection('history')">Recharge History</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><button class="dropdown-item" onclick="confirmLogout()">Logout</button></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4 content">
        <div id="dashboard" class="content-section">
            <div class="container mt-4">
                <div class="row g-3">
                    <div class="col-md-4 mx-auto">
                        <div class="dashboard-card h-90">
                            <div class="card-content">
                                <div>
                                    <div class="profile-image-container">
                                        <img id="profileImage" src="/assesst/Images/profile.jpeg" alt="Profile"
                                            class="profile-image">
                                    </div>
                                    <h4 class="dashboard-card-title text-center">My Account</h4>
                                    <div class="profile-details">
                                        <p><strong>Name:</strong> <span id="accountName"></span></p>
                                        <p><strong>Mobile:</strong> <span id="accountMobile"></span></p>
                                        <p><strong>Email:</strong> <span id="accountEmail"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        

                        <div class="dashboard-card h-90">
                            <div class="card-content">
                                <h4 class="dashboard-card-title text-center">Current Plan</h4>
                                <span class="badge validity-badge position-absolute top-0 end-0 p-2 m-2" id="days-left"></span>
                                <h5 class="mb-3 text-dark" id="plan-name-price"></h5>
                                <p><strong>Validity:</strong> <span id="validity"></span></p>
                                <p><strong>Calls:</strong> <span id="calls"></span></p>
                                <p><strong>SMS:</strong> <span id="sms"></span></p>
                                <p><strong>Data:</strong> <span id="data"></span></p>
                                <div class="btn-wrapper mt-2">
                                    <button class="dashboard-btn recharge-btn" onclick="showRechargeModal()">Recharge</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mx-auto">
                        <div class="dashboard-card h-90">
                            <div class="card-content">
                                <div>
                                    <div class="icon-circle mb-2">
                                        <i class="fas fa-wifi"></i>
                                    </div>
                                    <h5 class="dashboard-card-title">Data Usage</h5>
                                    <p class="text-muted mb-3">Track data consumption</p>
                                    <div class="progress mb-2" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" style="width: 80%;"
                                            aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="mb-3">
                                        <span class="fs-5 fw-bold" style="color: var(--primary-teal);">1.2GB</span>
                                        <span class="text-muted"> / 1.5GB Used</span>
                                    </div>
                                </div>
                                <button class="dashboard-btn mt-2">Add Data</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="plan-section" id="popular-plans">
                    <div class="container">
                        <h3>Popular Plans</h3>
                        <div class="plan-wrapper" id="popular-plans-container">
                            <!-- Popular plans will be dynamically populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="plans" class="content-section">
            <div class="filter-section">
                <div class="filter-item">
                    <label for="filter-name">Plan Name:</label>
                    <input type="text" id="filter-name" placeholder="Search by name">
                </div>
                <div class="filter-item">
                    <label for="filter-category">Category:</label>
                    <select id="filter-category">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="price-sort">Sort by Price:</label>
                    <select id="price-sort">
                        <option value="asc">Low to High</option>
                        <option value="desc">High to Low</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-success" id="apply-filters">Apply Filters</button>
                    <button class="btn btn-secondary" id="clear-filters">Clear Filters</button>
                </div>
            </div>
            <div class="plan-sections" id="plan-sections"></div>
        </div>

        <!-- Success Modal -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content success-modal">
                    <div class="modal-header">
                        <h5 class="modal-title">Recharge Successful</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Your recharge has been successfully processed!</p>
                        <p>Recharge ID: <span id="success-recharge-id"></span></p>
                        <button class="btn btn-primary w-100" id="view-invoice-btn">View Invoice</button>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success" id="back-home-btn">Back to Home</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Modal -->
        <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="invoiceModalLabel">Invoice Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Transaction ID:</strong> <span id="invoice-number"></span></p>
                        <p><strong>Subscriber Name:</strong> <span id="subscriber-name"></span></p>
                        <p><strong>Subscriber Number:</strong> <span id="subscriber-number"></span></p>
                        <p><strong>Plan Name:</strong> <span id="plan-name"></span></p>
                        <p><strong>Amount:</strong> ₹<span id="amount"></span></p>
                        <p><strong>Validity:</strong> <span id="plan-validity"></span></p>
                        <p><strong>Payment Method:</strong> <span id="payment-method"></span></p>
                        <p><strong>Issue Date:</strong> <span id="issue-date"></span></p>
                        <p><strong>Status:</strong> <span id="invoice-status"></span></p>
                        <p class="text-success" id="email-notification"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="download-invoice-btn" class="btn btn-primary">Download PDF</button>
                        <button type="button" id="back-to-home-btn" class="btn btn-secondary">Back to Home</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Include jsPDF library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Recharge</h5>
                        <button type="button" class="btn-close" id="close-confirmation-btn"
                            data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p id="modal-plan-details"></p>
                        <div class="mb-3">
                            <label for="payment-mode" class="form-label">Payment Mode</label>
                            <select class="form-select" id="payment-mode">
                                <option value="CARD">Card</option>
                                <option value="UPI">UPI</option>
                                <option value="NETBANKING">Net Banking</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancel">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmRecharge">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="history" class="content-section">
            <h3 style="text-align: center; margin-top: 50px;">Recharge History</h3>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Plan Name</th>
                            <th>Amount</th>
                            <th>Validity</th>
                            <th>Recharge Date</th>
                            <th>Payment Method</th>
                        </tr>
                    </thead>
                    <tbody id="rechargeTable"></tbody>
                </table>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center" id="paginationId"></ul>
            </nav>
        </div>

        <div id="notifications" class="content-section">
            <h3 class="text-center mb-4 text-primary" style="margin-top: 50px;">Notifications</h3>
            <div class="container">
                <div class="notification-list">
                    <div class="notification-card">
                        <div class="notification-text">
                            <p><strong>Plan Expiry Alert:</strong> Your plan is expiring in <strong>3 days</strong>.</p>
                            <span class="text-muted">[2025-02-20]</span>
                        </div>
                    </div>
                    <div class="notification-card">
                        <div class="notification-text">
                            <p><strong>Recharge Successful:</strong> ₹299 Unlimited Plan activated.</p>
                            <span class="text-muted">[2025-02-10]</span>
                        </div>
                    </div>
                    <div class="notification-card">
                        <div class="notification-text">
                            <p><strong>Special Offer:</strong> Get <span class="text-danger">10% extra data</span> on
                                the ₹599 plan!</p>
                            <span class="text-muted">[2025-02-05]</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile" class="content-section">
            <h3 style="text-align: center; margin-top: 50px;">Profile</h3>
            <div class="container p-4 border rounded bg-white shadow-sm" style="max-width: 500px;">
                <div class="text-center">
                    <label for="profileImageInput">
                        <img id="profileImage" src="/assesst/Images/profile.jpeg" class="rounded-circle mb-3" width="120" height="120">
                    </label>
                    <input type="file" id="profileImageInput"style="display: none;">
                    <h4 class="mb-1" id="displayUserName"></h4>
                    <p class="text-muted">Mobile Prepaid User</p>
                </div>
                <hr>
                <div class="mb-3">
                    <label class="form-label"><strong>Name:</strong></label>
                    <input type="text" class="form-control" id="userName">
                    <p class="text-danger mt-1 error-message" id="nameError"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Mobile Number:</strong></label>
                    <input type="text" id="mobileInput" class="form-control" disabled>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Email:</strong></label>
                    <input type="email" class="form-control" id="emailInput">
                    <p class="text-danger mt-1 error-message" id="emailError"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Alternate Mobile Number:</strong></label>
                    <input type="text" id="mobilenumber" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Address:</strong></label>
                    <textarea id="address" class="form-control" rows="2"></textarea>
                    <p class="text-danger mt-1 error-message" id="addressError"></p>
                </div>
                <button type="button" id="updateProfileBtn" class="btn btn-primary w-100">Update</button>
            </div>
        </div>
    
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="successToast" class="toast bg-success text-white" role="alert">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
            <div id="errorToast" class="toast bg-danger text-white" role="alert">
                <div class="d-flex">
                    <div class="toast-body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>
        <div id="support" class="content-section">
            <div class="container mt-5">
                <div class="card p-4 shadow">
                    <h3 class="text-center mb-4">Contact Support</h3>
                    <form id="supportForm">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" id="name" class="form-control" placeholder="Enter your name">
                            <small class="text-danger d-none" id="namesError">Name is required</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" class="form-control" placeholder="Enter your email">
                            <small class="text-danger d-none" id="emailsError">Valid email is required</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <input type="text" id="subject" class="form-control" placeholder="Enter subject">
                            <small class="text-danger d-none" id="subjectError">Subject is required</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea id="message" class="form-control" rows="4"
                                placeholder="Enter your message"></textarea>
                            <small class="text-danger d-none" id="messageError">Message cannot be empty</small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Send Message</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;"></div>
        <button id="homeButton"><i class="fas fa-arrow-up"></i></button>

        <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to log out?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmLogoutBtn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="container py-5">
            <div class="row">
                <div class="col-md-6 footer-column mb-4 mb-md-0">
                    <h5>About Mobi.Comm</h5>
                    <p>We provide quick and secure mobile recharges for prepaid users. Our goal is to make recharge
                        services simple, efficient, and accessible.</p>
                </div>
                <div class="col-md-6 footer-column">
                    <h5>Contact</h5>
                    <p>Email: <a href="mailto:support@mobi.comm">support@mobi.comm</a></p>
                    <p>Phone: +1 234 567 890</p>
                    <div class="social-icons">
                        <a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-icon"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom text-center mt-4">
                <p>© 2025 Mobi.Comm - All Rights Reserved</p>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
const apiBaseUrl = 'http://localhost:8083/subscriber';

// Token Management
function getToken() {
    const token = sessionStorage.getItem('jwtToken');
    if (!token) {
        window.location.href = 'login.html';
        return null;
    }
    return token;
}

function getSubscriberIdFromToken() {
    const token = getToken();
    if (!token) return null;
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        console.log('JWT Payload:', payload);
        return payload.sub;
    } catch (error) {
        console.error('Error decoding JWT:', error);
        return null;
    }
}

// Fetch Utility
async function fetchWithAuth(url, options = {}) {
    const token = getToken();
    const headers = {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` }),
    };
    console.log('Request URL:', url);
    console.log('Request headers:', headers);

    try {
        const response = await fetch(url, { ...options, headers: { ...options.headers, ...headers } });
        if (response.status === 401) {
            console.error('Unauthorized. Redirecting to login...');
            window.location.href = 'index.html';
            throw new Error('Unauthorized');
        }
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to fetch from ${url}: ${response.status} - ${errorText}`);
        }
        return response.json();
    } catch (error) {
        console.error('Fetch error:', error);
        throw error;
    }
}

// Subscriber Details

async function loadSubscriberDetails() {
    try {
        const subscriber = await fetchWithAuth(`${apiBaseUrl}/me?type=account`);
        document.getElementById('accountName').textContent = subscriber.name || 'N/A';
        document.getElementById('accountMobile').textContent = `+91 ${subscriber.phoneNumber}` || 'N/A';
        document.getElementById('accountEmail').textContent = subscriber.email || 'N/A';

        const profileImage = document.getElementById("profileImage");
        if (subscriber.profileImageUrl) {
            console.log("Profile Image Base64 (Account):", subscriber.profileImageUrl.substring(0, 50) + "...");
            console.log("Full Base64 Length:", subscriber.profileImageUrl.length);

            let base64String = subscriber.profileImageUrl;
            if (!base64String.startsWith("data:image")) {
                base64String = `data:image/jpeg;base64,${base64String}`;
                profileImage.src = base64String;
                console.log("Trying JPEG MIME type");

                profileImage.onerror = () => {
                    console.log("JPEG failed, trying PNG");
                    base64String = `data:image/png;base64,${subscriber.profileImageUrl}`;
                    profileImage.src = base64String;

                    profileImage.onerror = () => {
                        console.error("Failed to render image with both JPEG and PNG MIME types");
                        profileImage.src = "/assesst/Images/profile.jpeg";
                        profileImage.alt = "Failed to load profile photo";
                    };
                };
            } else {
                profileImage.src = base64String;
            }
        } else {
            profileImage.src = "/assesst/Images/profile.jpeg";
            profileImage.alt = "No profile photo available";
        }
    } catch (error) {
        console.error('Error loading subscriber details:', error);
        document.getElementById('accountName').textContent = 'Error';
        document.getElementById('accountMobile').textContent = 'Error';
        document.getElementById('accountEmail').textContent = 'Error';
        const profileImage = document.getElementById("profileImage");
        profileImage.src = "/assesst/Images/profile.jpeg";
        profileImage.alt = "Failed to load profile photo";
    }
}
// Categories
async function loadCategories() {
    try {
        const categories = await fetchWithAuth(`${apiBaseUrl}/categories`);
        const categorySelect = document.getElementById('filter-category');
        categorySelect.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.name;
            categorySelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Plans
async function fetchPopularPlans() {
    const container = document.getElementById('popular-plans-container');
    container.innerHTML = '<p>Loading popular plans...</p>';
    try {
        const query = new URLSearchParams({
            page: 0,
            size: 10,
            sortBy: 'price',
            sortDir: 'asc',
            category: 'Popular Plan',
        }).toString();
        const plansPage = await fetchWithAuth(`${apiBaseUrl}/plans?${query}`);
        const plans = plansPage.content || plansPage;

        container.innerHTML = '';
        if (!plans || plans.length === 0) {
            container.innerHTML = '<p>No popular plans available.</p>';
            return;
        }

        plans.forEach(plan => {
            const planCard = createPlanCard(plan);
            container.innerHTML += planCard;
        });

        attachRechargeButtonListeners();
    } catch (error) {
        console.error('Error fetching popular plans:', error);
        container.innerHTML = '<p>Error loading popular plans.</p>';
    }
}

async function fetchPlans(filters = {}) {
    const planSections = document.getElementById('plan-sections');
    planSections.innerHTML = '<p>Loading plans...</p>';
    try {
        const query = new URLSearchParams({
            page: 0,
            size: 100,
            sortBy: 'price',
            sortDir: filters.sortDir || 'asc',
            name: filters.name || '',
            category: filters.category || '',
        }).toString();
        const plansPage = await fetchWithAuth(`${apiBaseUrl}/plans?${query}`);
        const plans = plansPage.content || plansPage;

        planSections.innerHTML = '';
        const plansByCategory = groupPlansByCategory(plans);

        Object.entries(plansByCategory).forEach(([category, plans]) => {
            const section = document.createElement('div');
            section.className = 'plan-section';
            section.innerHTML = `
                <div class="container">
                    <h3>${category}</h3>
                    <div class="plan-wrapper" id="${category}-container"></div>
                </div>
            `;
            planSections.appendChild(section);

            const container = document.getElementById(`${category}-container`);
            plans.forEach(plan => container.innerHTML += createPlanCard(plan));
        });

        attachRechargeButtonListeners();
        if (Object.keys(plansByCategory).length === 0) {
            planSections.innerHTML = '<p>No plans found.</p>';
        }
    } catch (error) {
        console.error('Error fetching plans:', error);
        planSections.innerHTML = '<p>Error loading plans.</p>';
    }
}

function createPlanCard(plan) {
    return `
        <div class="plan-card">
            <h4>${plan.name}</h4>
            <p>Price: ${plan.price}</p>
            <p>Data: ${plan.dataLimit || 'N/A'}</p>
            <p>Validity: ${plan.validity} days</p>
            <p>SMS: ${plan.smsLimit || 'N/A'}</p>
            <p>Calls: ${plan.callLimit || 'N/A'}</p>
            <button class="btn btn-primary recharge-btn" 
                    data-plan-id="${plan.id}" 
                    data-plan-name="${plan.name}" 
                    data-plan-validity="${plan.validity}"
                    data-plan-price="${plan.price}">Recharge</button>
        </div>
    `;
}

function groupPlansByCategory(plans) {
    const plansByCategory = {};
    plans.forEach(plan => {
        const category = plan.category || 'Uncategorized';
        if (!plansByCategory[category]) plansByCategory[category] = [];
        plansByCategory[category].push(plan);
    });
    return plansByCategory;
}

function attachRechargeButtonListeners() {
    document.querySelectorAll('.recharge-btn').forEach(btn => 
        btn.addEventListener('click', showRechargeModal)
    );
}

// Recharge Flow
function showRechargeModal(event) {
    const btn = event.target;
    const planId = btn.dataset.planId;
    const planName = btn.dataset.planName;
    const planPrice = parseFloat(btn.dataset.planPrice);
    const planValidity = btn.dataset.planValidity;

    document.getElementById('modal-plan-details').textContent = 
        `Recharge Plan: ${planName} for ₹${planPrice} (${planValidity} days)`;
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    confirmationModal.show();

    document.getElementById('cancel').onclick = () => confirmationModal.hide();
    document.getElementById('close-confirmation-btn').onclick = () => confirmationModal.hide();
    document.getElementById('confirmRecharge').onclick = () => 
        confirmRecharge(planId, confirmationModal, planName, planPrice, planValidity);
}

async function fetchSubscriberId(phoneNumber) {
    try {
        const response = await fetchWithAuth(`${apiBaseUrl}/subscriber-id?phoneNumber=${phoneNumber}`);
        return response;
    } catch (error) {
        console.error('Error fetching subscriber ID:', error);
        return null;
    }
}

function proceedPayment(planName, planId, price, subscriberId, callback) {
    const options = {
        "key": "rzp_test_hFoXVarHVhtB0H",
        "amount": price * 100,
        "currency": "INR",
        "name": "Mobi.comm",
        "description": `${planName} - ${planId}`,
        "handler": function (response) {
            alert("Payment successful! Payment ID: " + response.razorpay_payment_id);
            if (callback) callback(response.razorpay_payment_id);
        },
        "prefill": {
            "name": "Yuvasree",
            "email": "Yuvasree@example.com",
            "contact": "6374116113"
        },
        "theme": { "color": "#008080" },
        "modal": { "ondismiss": () => alert("Payment cancelled.") }
    };
    const rzp = new Razorpay(options);
    rzp.open();
}

async function confirmRecharge(planId, confirmationModal, planName, planPrice, planValidity) {
    try {
        const paymentMode = document.getElementById('payment-mode').value;
        const phoneNumber = getSubscriberIdFromToken();
        if (!phoneNumber) throw new Error('No phone number found in token. Please log in again.');

        const subscriberId = await fetchSubscriberId(phoneNumber);
        if (!subscriberId) throw new Error('No subscriber ID found.');

        proceedPayment(planName, planId, planPrice, subscriberId, async (paymentId) => {
            const rechargeRequest = {
                subscriberId: subscriberId,
                planId: parseInt(planId),
                planName: planName,
                planPrice: planPrice,
                planValidity: planValidity,
                paymentMode: paymentMode,
                paymentId: paymentId
            };

            const response = await fetchWithAuth(`${apiBaseUrl}/recharge`, {
                method: 'POST',
                body: JSON.stringify(rechargeRequest),
            });

            confirmationModal.hide();
            showInvoiceModal(response); 
        });
    } catch (error) {
        console.error('Recharge error:', error);
        alert('Failed to process recharge: ' + error.message);
    }
}

function showInvoiceModal(response) {
    const invoiceModal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    
    
    document.getElementById('invoice-number').textContent = response.transactionId;
    document.getElementById('subscriber-name').textContent = response.subscriberName;
    document.getElementById('subscriber-number').textContent = response.subscriberNumber;
    document.getElementById('plan-name').textContent = response.planName;
    document.getElementById('amount').textContent = response.planPrice.toFixed(2);
    document.getElementById('plan-validity').textContent = `${response.planValidity} days` || 'N/A';
    document.getElementById('payment-method').textContent = response.paymentMethod;
    document.getElementById('issue-date').textContent = response.rechargeDate;
    document.getElementById('invoice-status').textContent = response.status;
    
    
    const emailNotification = document.getElementById('email-notification');
    if (emailNotification) {
        emailNotification.textContent = 'Your invoice has been sent to your registered email ID.';
    }

    invoiceModal.show();

    document.getElementById('download-invoice-btn').onclick = () => downloadInvoice(response);
    document.getElementById('back-to-home-btn').onclick = () => {
        invoiceModal.hide();
        showSection('dashboard');
        refreshRechargeHistory();
    };
}
function downloadInvoice(transaction) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

   
    doc.setFillColor(0, 128, 128);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.text('Mobi.comm Prepaid Service', 20, 20);
    doc.setFontSize(14);
    doc.setFont("helvetica", "normal");
    doc.text('Your Recharge Invoice', 20, 30);
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    const leftMargin = 20;
    const valueMargin = 90; 
    const startY = 50;
    const lineHeight = 10;

    const details = [
        { label: 'Transaction ID', value: transaction.transactionId },
        { label: 'Subscriber Name', value: transaction.subscriberName },
        { label: 'Subscriber Number', value: transaction.subscriberNumber },
        { label: 'Plan Name', value: transaction.planName },
        { label: 'Amount', value: `₹${transaction.planPrice.toFixed(2)}` },
        { label: 'Validity', value: `${transaction.planValidity || 'N/A'} days` },
        { label: 'Payment Method', value: transaction.paymentMethod },
        { label: 'Issue Date', value: transaction.rechargeDate },
        { label: 'Status', value: transaction.status }
    ];

    details.forEach((item, index) => {
        const yPosition = startY + (index * lineHeight);

        doc.setFont("helvetica", "bold");
        doc.text(item.label, leftMargin, yPosition);
        doc.setFont("helvetica", "normal");
        doc.text(item.value, valueMargin, yPosition);
        if (index < details.length) {
            doc.setLineWidth(0.1);
            doc.setDrawColor(200, 200, 200); 
            doc.line(leftMargin, yPosition + 2, 190, yPosition + 2);
        }
    });

    const footerY = startY + (details.length * lineHeight) + 20;
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('Thank you for choosing Mobi.comm Prepaid Service!', 105, footerY, { align: 'center' });
    doc.text('Contact us at support@mobicomm.com for any queries.', 105, footerY + 5, { align: 'center' });

    doc.save(`invoice_${transaction.transactionId}.pdf`);
}
// Recharge History
function refreshRechargeHistory() {
    const table = document.getElementById("rechargeTable");
    const rowsPerPage = 5;
    let currentPage = 1;
    const pagination = document.getElementById("paginationId");

    async function loadTransactions() {
        try {
            const transactions = await fetchWithAuth(`${apiBaseUrl}/transactions`);
            return transactions.map(tx => ({
                transactionId: tx.transactionId,
                planName: tx.planName,
                amount: `₹${tx.planPrice.toFixed(2)}`,
                validity: tx.planValidity || 'N/A',
                rechargeDate: tx.rechargeDate,
                paymentMethod: tx.paymentMethod
            }));
        } catch (error) {
            console.error('Error fetching transactions:', error);
            return [];
        }
    }

    function showPage(page, rows) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        table.innerHTML = '';
        rows.slice(start, end).forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.transactionId}</td>
                <td>${row.planName}</td>
                <td>${row.amount}</td>
                <td>${row.validity}</td>
                <td>${row.rechargeDate}</td>
                <td>${row.paymentMethod}</td>
            `;
            table.appendChild(tr);
        });
        updatePagination(page, rows);
    }

    function updatePagination(activePage, rows) {
        pagination.innerHTML = '';
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${activePage === 1 ? "disabled" : ""}`;
        prevLi.innerHTML = `<a class="page-link" href="#">«</a>`;
        prevLi.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage, rows);
            }
        });
        pagination.appendChild(prevLi);

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = `page-item ${i === activePage ? "active" : ""}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", (e) => {
                e.preventDefault();
                currentPage = i;
                showPage(currentPage, rows);
            });
            pagination.appendChild(li);
        }

        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${activePage === totalPages ? "disabled" : ""}`;
        nextLi.innerHTML = `<a class="page-link" href="#">»</a>`;
        nextLi.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage, rows);
            }
        });
        pagination.appendChild(nextLi);
    }

    loadTransactions().then(rows => showPage(currentPage, rows));
}

// Section Navigation
function showSection(sectionId) {
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = section.id === sectionId ? 'block' : 'none';
    });
    if (sectionId === 'history') refreshRechargeHistory();
}

fetch('http://localhost:8083/subscriber/current-plan', { headers: { 'Authorization': 'Bearer YOUR_TOKEN' } })
        .then(response => response.json())
        .then(data => {
            document.getElementById('days-left').textContent = `${data.daysLeft} Days left`;
            document.getElementById('plan-name-price').textContent = `${data.planName} | ₹${data.planPrice}`;
            document.getElementById('validity').textContent = `${data.validity} Days`;
            document.getElementById('calls').textContent = data.calls;
            document.getElementById('sms').textContent = data.sms;
            document.getElementById('data').textContent = data.data;
        })
        .catch(error => console.error('Error fetching plan:', error));

// Profile Management
function setupProfileManagement() {
    const profileImageInput = document.getElementById("profileImageInput"); 
    const profileImage = document.getElementById("profileImage"); 
    const navbarAvatar = document.getElementById("navbarAvatar"); 
    const userName = document.getElementById("userName");
    const emailInput = document.getElementById("emailInput");
    const mobileInput = document.getElementById("mobileInput");
    const alternateMobileNumber = document.getElementById("mobilenumber");
    const address = document.getElementById("address");
    const displayUserName = document.getElementById("displayUserName");
    const updateProfileBtn = document.getElementById("updateProfileBtn");
    const nameError = document.getElementById("nameError");
    const emailError = document.getElementById("emailError");
    const addressError = document.getElementById("addressError");

    let profileImageBase64 = null; 

    function showToast(toastId, message) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.querySelector(".toast-body").textContent = message;
            new bootstrap.Toast(toast).show();
        } else {
            const toastContainer = document.createElement("div");
            toastContainer.className = "position-fixed bottom-0 end-0 p-3";
            toastContainer.style.zIndex = "1050";
            toastContainer.innerHTML = `
                <div class="toast bg-${toastId === 'successToast' ? 'success' : 'danger'} text-white show" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toastContainer);
            setTimeout(() => toastContainer.remove(), 3000);
        }
    }

    function validateInput() {
        let isValid = true;

        if (!userName.value.trim() || !/^[a-zA-Z\s]{3,}$/.test(userName.value.trim())) {
            nameError.textContent = "Enter a valid name (min 3 letters, letters only)";
            isValid = false;
        } else {
            nameError.textContent = "";
        }

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailInput.value.trim() || !emailPattern.test(emailInput.value.trim())) {
            emailError.textContent = "Enter a valid email";
            isValid = false;
        } else {
            emailError.textContent = "";
        }

        if (!address.value.trim()) {
            addressError.textContent = "Address is required";
            isValid = false;
        } else {
            addressError.textContent = "";
        }

        return isValid;
    }

    async function fetchProfileDetails() {
        try {
            const profile = await fetchWithAuth(`${apiBaseUrl}/me?type=profile`);
            displayProfileDetails(profile);
        } catch (error) {
            console.error("Error fetching profile details:", error);
            showToast("errorToast", error.message || "Failed to load profile details. Please try again.");
        }
    }

    function displayProfileDetails(profile) {
        displayUserName.textContent = profile.name || "N/A";
        userName.value = profile.name || "";
        mobileInput.value = `+91 ${profile.phoneNumber}` || "N/A";
        emailInput.value = profile.email || "";
        alternateMobileNumber.value = profile.alternateMobileNumber || "";
        address.value = profile.address || "";

        if (profile.profileImageUrl) {
            let base64String = profile.profileImageUrl;
            if (!base64String.startsWith("data:image")) {
                base64String = `data:image/jpeg;base64,${base64String}`;
                profileImage.src = base64String;
                profileImage.onerror = () => {
                    base64String = `data:image/png;base64,${profile.profileImageUrl}`;
                    profileImage.src = base64String;
                    profileImage.onerror = () => {
                        profileImage.src = "/assesst/Images/profile.jpeg";
                        profileImage.alt = "Failed to load profile photo";
                    };
                };
            } else {
                profileImage.src = base64String;
            }
            if (navbarAvatar) navbarAvatar.src = profileImage.src;
        } else {
            profileImage.src = "/assesst/Images/profile.jpeg";
            profileImage.alt = "No profile photo available";
            if (navbarAvatar) navbarAvatar.src = "/assesst/Images/profile.jpeg";
        }
    }

    // Handle image upload and preview
    profileImageInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                profileImageBase64 = e.target.result; 
                profileImage.src = profileImageBase64;
                if (navbarAvatar) {
                    navbarAvatar.src = profileImageBase64;
                }
            };
            reader.readAsDataURL(file);
        } else {
            profileImageBase64 = null;
        }
    });

    updateProfileBtn.addEventListener("click", async () => {
        if (!validateInput()) return;

        const updatedProfile = {
            name: userName.value.trim(),
            email: emailInput.value.trim(),
            alternateMobileNumber: alternateMobileNumber.value.trim(),
            address: address.value.trim(),
            profileImageUrl: profileImageBase64
        };

        try {
            const response = await fetchWithAuth(`${apiBaseUrl}/update`, {
                method: "PUT",
                body: JSON.stringify(updatedProfile),
            });

            displayProfileDetails(response);
            showToast("successToast", "Profile updated successfully!");
        } catch (error) {
            console.error("Error updating profile:", error);
            showToast("errorToast", error.message || "Failed to update profile. Please try again.");
        }
    });

    userName.addEventListener("input", validateInput);
    emailInput.addEventListener("input", validateInput);
    address.addEventListener("input", validateInput);

    fetchProfileDetails();
}

// Support Form
function setupSupportForm() {
    const supportForm = document.getElementById("supportForm");
    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const subjectInput = document.getElementById("subject");
    const messageInput = document.getElementById("message");
    const nameError = document.getElementById("namesError");
    const emailError = document.getElementById("emailsError");
    const subjectError = document.getElementById("subjectError");
    const messageError = document.getElementById("messageError");

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function showError(input, errorElement, message) {
        errorElement.textContent = message;
        errorElement.classList.remove("d-none");
        input.classList.add("is-invalid");
    }

    function clearError(input, errorElement) {
        errorElement.classList.add("d-none");
        input.classList.remove("is-invalid");
    }

    function validateName() {
        let nameValue = nameInput.value.trim();
        if (nameValue === "") {
            showError(nameInput, nameError, "Name is required.");
            return false;
        } else if (nameValue.length < 3) {
            showError(nameInput, nameError, "Name must be at least 3 characters long.");
            return false;
        }
        clearError(nameInput, nameError);
        return true;
    }

    function validateEmail() {
        let emailValue = emailInput.value.trim();
        if (emailValue === "") {
            showError(emailInput, emailError, "Email is required.");
            return false;
        } else if (!emailRegex.test(emailValue)) {
            showError(emailInput, emailError, "Enter a valid email address.");
            return false;
        }
        clearError(emailInput, emailError);
        return true;
    }

    function validateSubject() {
        let subjectValue = subjectInput.value.trim();
        if (subjectValue === "") {
            showError(subjectInput, subjectError, "Subject is required.");
            return false;
        } else if (subjectValue.length < 5) {
            showError(subjectInput, subjectError, "Subject must be at least 5 characters long.");
            return false;
        }
        clearError(subjectInput, subjectError);
        return true;
    }

    function validateMessage() {
        let messageValue = messageInput.value.trim();
        if (messageValue === "") {
            showError(messageInput, messageError, "Message cannot be empty.");
            return false;
        } else if (messageValue.length < 10) {
            showError(messageInput, messageError, "Message must be at least 10 characters long.");
            return false;
        }
        clearError(messageInput, messageError);
        return true;
    }

    nameInput.addEventListener("input", validateName);
    emailInput.addEventListener("input", validateEmail);
    subjectInput.addEventListener("input", validateSubject);
    messageInput.addEventListener("input", validateMessage);

    function showToast(message, type) {
        const toastContainer = document.getElementById("toastContainer") || createToastContainer();
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
        toast.style = "position: relative; min-width: 250px;";
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function createToastContainer() {
        const container = document.createElement("div");
        container.id = "toastContainer";
        container.className = "position-fixed bottom-0 end-0 p-3";
        container.style.zIndex = "1050";
        document.body.appendChild(container);
        return container;
    }

    supportForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const isNameValid = validateName();
        const isEmailValid = validateEmail();
        const isSubjectValid = validateSubject();
        const isMessageValid = validateMessage();

        if (isNameValid && isEmailValid && isSubjectValid && isMessageValid) {
            showToast("Message Sent Successfully!", "success");
            supportForm.reset();
        }
    });
}

// Filter Controls
document.getElementById('apply-filters')?.addEventListener('click', () => {
    const filters = {
        name: document.getElementById('filter-name')?.value.trim() || '',
        category: document.getElementById('filter-category')?.value || '',
        sortDir: document.getElementById('price-sort')?.value || 'asc',
    };
    fetchPlans(filters);
});

document.getElementById('clear-filters')?.addEventListener('click', () => {
    document.getElementById('filter-name').value = '';
    document.getElementById('filter-category').value = '';
    document.getElementById('price-sort').value = 'asc';
    fetchPlans();
});

function confirmLogout() {
    const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));
    logoutModal.show();

    const apiBaseUrl = "http://localhost:8083/auth"; 
    const confirmBtn = document.getElementById('confirmLogoutBtn');

    confirmBtn.onclick = async () => {
        const token = sessionStorage.getItem('jwtToken');

        if (!token) {
            showToast("errorToast", "No session token found. You are already logged out.");
            sessionStorage.removeItem('jwtToken');
            logoutModal.hide();
            window.location.href = '../index.html';
            return;
        }

        try {
            const response = await fetch(`${apiBaseUrl}/logout/subscriber`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || "Logout failed!");
            }

            sessionStorage.removeItem('jwtToken');
            showToast("successToast", result.message || "Logged out successfully!");
            logoutModal.hide();

            setTimeout(() => {
                window.location.href = '/index.html';
            }, 1000);
        } catch (error) {
            console.error("Error during logout:", error);
            showToast("errorToast", error.message || "Failed to logout. Please try again.");
        }
    };
}

function showToast(toastId, message) {
    const toastContainer = document.getElementById("toastContainer");
    if (!toastContainer) {
        console.error("Toast container not found in DOM");
        return;
    }
    const toastHTML = `
        <div class="toast bg-${toastId === 'successToast' ? 'success' : 'danger'} text-white" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    toastContainer.innerHTML = toastHTML;
    const toastElement = toastContainer.querySelector(".toast");
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    setTimeout(() => toastElement.remove(), 3000);
}

window.confirmLogout = confirmLogout;


// Fetch and Display Current Plan
async function loadCurrentPlan() {
    try {
        const currentPlan = await fetchWithAuth(`${apiBaseUrl}/current-plan`);
        if (!currentPlan) {
            document.getElementById('plan-name-price').textContent = 'No active plan';
            document.getElementById('days-left').textContent = 'N/A';
            document.getElementById('validity').textContent = 'N/A';
            document.getElementById('calls').textContent = 'N/A';
            document.getElementById('sms').textContent = 'N/A';
            document.getElementById('data').textContent = 'N/A';
            return;
        }
        document.getElementById('days-left').textContent = `${currentPlan.daysLeft} days left`;
        document.getElementById('plan-name-price').textContent = `${currentPlan.planName} - ₹${currentPlan.planPrice}`;
        document.getElementById('validity').textContent = `${currentPlan.validity} days`;
        document.getElementById('calls').textContent = currentPlan.calls || 'N/A';
        document.getElementById('sms').textContent = currentPlan.sms || 'N/A';
        document.getElementById('data').textContent = currentPlan.data || 'N/A';

        const daysLeftBadge = document.getElementById('days-left');
        daysLeftBadge.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        if (currentPlan.daysLeft <= 5) {
            daysLeftBadge.classList.add('bg-danger');
        } else if (currentPlan.daysLeft <= 10) {
            daysLeftBadge.classList.add('bg-warning');
        } else {
            daysLeftBadge.classList.add('bg-success');
        }
    } catch (error) {
        console.error('Error loading current plan:', error);
        const errorMessage = error.message.includes('null') ? 'No active plan or invalid data' : 'Server error';
        document.getElementById('plan-name-price').textContent = `Error loading plan: ${errorMessage}`;
        document.getElementById('days-left').textContent = 'N/A';
    }
}

async function setAvatarTooltip() {
    try {
        const response = await fetch('http://localhost:8083/subscriber/me', {
            headers: { 'Authorization': 'Bearer ' + sessionStorage.getItem('jwtToken') }
        });
        const userData = await response.json();
        const userName = userData.name; 
        document.getElementById('navbarAvatar').setAttribute('title', userName);
    } catch (error) {
        console.error('Error fetching user data:', error);
        document.getElementById('navbarAvatar').setAttribute('title', 'User');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    refreshRechargeHistory();
    setupSupportForm();
    loadCategories();
    fetchPlans();
    fetchPopularPlans();
    setupProfileManagement();
    loadSubscriberDetails();
    setAvatarTooltip(),
    loadCurrentPlan(),
    showSection('dashboard');
});


</script>
    <script src="script.js"></script>
</body>

</html>